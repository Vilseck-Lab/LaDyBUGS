* CHARMM stream file for OpenMM setup
* Originally written by JZV (02/2019) for ALF (RLH 01/2019)
* Modified for OpenMM use by MTR (08/2021)*
set ligseg = lig
set resnum = 1

! perturbation variables
set nsites = 1 
set nsubs1 = 6 
set nblocks = 6 

bomblev -3

!! Reads coordinates and pdb file for the ligand
read sequ pdb name @builddir/core.pdb
generate @ligseg setup
read coor pdb resid name @builddir/core.pdb

!! Read in the ligand patch rtf files
read rtf append card name @builddir/site1_sub1_pres.rtf
read rtf append card name @builddir/site1_sub2_pres.rtf
read rtf append card name @builddir/site1_sub3_pres.rtf
read rtf append card name @builddir/site1_sub4_pres.rtf
read rtf append card name @builddir/site1_sub5_pres.rtf
read rtf append card name @builddir/site1_sub6_pres.rtf

!! Read in the ligand fragment pdb files
ic generate

patch p1_1 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub1_frag.pdb
ic param
ic build

patch p1_2 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub2_frag.pdb
ic param
ic build

patch p1_3 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub3_frag.pdb
ic param
ic build

patch p1_4 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub4_frag.pdb
ic param
ic build

patch p1_5 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub5_frag.pdb
ic param
ic build

patch p1_6 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub6_frag.pdb
ic param
ic build

!! Read in LonePair sites (if applicable)
stream @builddir/lpsites.inp

!! Define MSLD substituent selections
define site1_sub1 - 
   select ( - 
   atom @ligseg @resnum C039 .or. -
   atom @ligseg @resnum H040 .or. -
   atom @ligseg @resnum C041 .or. -
   atom @ligseg @resnum H042 .or. -
   atom @ligseg @resnum C043 .or. -
   atom @ligseg @resnum H044 .or. -
   none ) end

define site1_sub2 - 
   select ( - 
   atom @ligseg @resnum C045 .or. -
   atom @ligseg @resnum H046 .or. -
   atom @ligseg @resnum C047 .or. -
   atom @ligseg @resnum Cl0A .or. -
   atom @ligseg @resnum C048 .or. -
   atom @ligseg @resnum H049 .or. -
   none ) end

define site1_sub3 - 
   select ( - 
   atom @ligseg @resnum C050 .or. -
   atom @ligseg @resnum H051 .or. -
   atom @ligseg @resnum C052 .or. -
   atom @ligseg @resnum F053 .or. -
   atom @ligseg @resnum C054 .or. -
   atom @ligseg @resnum H055 .or. -
   none ) end

define site1_sub4 - 
   select ( - 
   atom @ligseg @resnum C056 .or. -
   atom @ligseg @resnum H057 .or. -
   atom @ligseg @resnum C058 .or. -
   atom @ligseg @resnum N059 .or. -
   atom @ligseg @resnum H060 .or. -
   atom @ligseg @resnum H061 .or. -
   atom @ligseg @resnum C062 .or. -
   atom @ligseg @resnum H063 .or. -
   none ) end

define site1_sub5 - 
   select ( - 
   atom @ligseg @resnum C064 .or. -
   atom @ligseg @resnum H065 .or. -
   atom @ligseg @resnum C066 .or. -
   atom @ligseg @resnum O067 .or. -
   atom @ligseg @resnum C068 .or. -
   atom @ligseg @resnum H069 .or. -
   atom @ligseg @resnum H070 .or. -
   atom @ligseg @resnum H071 .or. -
   atom @ligseg @resnum C072 .or. -
   atom @ligseg @resnum H073 .or. -
   none ) end

define site1_sub6 - 
   select ( - 
   atom @ligseg @resnum C074 .or. -
   atom @ligseg @resnum H075 .or. -
   atom @ligseg @resnum C076 .or. -
   atom @ligseg @resnum O077 .or. -
   atom @ligseg @resnum H078 .or. -
   atom @ligseg @resnum C079 .or. -
   atom @ligseg @resnum H080 .or. -
   none ) end

auto angle dihe  !! do not call after deleting sub-sub terms or loading in water
bomblev -1

! delete angles and dihedrals between alchem groups
set ii = 1
label deletesiteloop
if @ii .le. @nsites then

   set jj = 1
   label delete1loop
   if @jj .le. @nsubs@@ii then

      calc kk = @jj + 1
      label delete2loop
      if @kk .le. @nsubs@@ii then

         dele connectivity sele ( site@{ii}_sub@@jj ) show end sele ( site@{ii}_sub@@kk ) show end
         calc kk = @kk + 1
         goto delete2loop
      endif

      calc jj = @jj + 1
      goto delete1loop
   endif

   calc ii = @ii + 1
   goto deletesiteloop
endif

!! ! System specific deletion (linear groups)
!! dele dihe sele (atom LIG 1 ATOMNAME) show end

